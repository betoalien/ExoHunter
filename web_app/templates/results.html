<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1" />
  <title>ExoHunter · Results</title>

  <link rel="stylesheet" href="/static/css/styles.css" />
  <meta name="description" content="ExoHunter — View processed results, filter by category, and download CSV/JSON reports." />
  <meta name="color-scheme" content="light dark" />
</head>
<body>
  <header class="site-header" role="banner">
    <nav class="nav container" aria-label="Primary">
      <div class="brand">
        <a class="brand-link" href="/">ExoHunter</a>
      </div>
      <ul class="nav-list">
        <li><a href="/">Home</a></li>
        <li><a aria-current="page" href="/results">Results</a></li>
        <li><a href="/healthz" target="_blank" rel="noopener">Health</a></li>
      </ul>
    </nav>
  </header>

  <!-- Slim hero for consistency -->
  <section class="hero" style="max-height: 280px; height: 28vh;" role="region" aria-label="Header banner">
    <div class="hero-overlay"></div>
    <div class="hero-content container">
      <h1 class="hero-title">Results</h1>
      <p class="hero-subtitle">Review processed objects, filter by category, and download reports.</p>
    </div>
  </section>

  <main id="main" class="container" role="main">
    <!-- Actions / Downloads -->
    <section class="card section">
      <header class="section-header">
        <h2>Report Outputs</h2>
        <p class="section-subtitle">Download the latest processed report or refresh to fetch new results.</p>
      </header>

      <div class="results-actions" style="display:flex; gap:0.75rem; flex-wrap:wrap;">
        <a id="linkDownloadCSV" class="btn btn-primary" href="#" download aria-disabled="true">Download CSV</a>
        <a id="linkDownloadJSON" class="btn btn-ghost" href="#" download aria-disabled="true">Download JSON</a>
        <button id="btnRefreshResults" type="button" class="btn btn-ghost">Refresh</button>
      </div>

      <div id="resultsStatus" class="status status--info" role="status" aria-live="polite" style="margin-top:1rem;">
        Waiting for results…
      </div>

      <output id="resultsSummary" class="output" style="display:block; margin-top:0.75rem;"></output>
    </section>

    <!-- Filters -->
    <section class="card section">
      <header class="section-header">
        <h2>Filters</h2>
        <p class="section-subtitle">Quickly narrow down by ID or category. (Client-side filter for now.)</p>
      </header>

      <form id="filterForm" class="form-grid" novalidate>
        <div class="form-row">
          <label for="searchId" class="form-label">Search by Object ID</label>
          <input id="searchId" name="searchId" type="text" placeholder="e.g., KOI-1234" />
        </div>

        <div class="form-row">
          <label for="categorySelect" class="form-label">Category</label>
          <select id="categorySelect" name="category">
            <option value="">All</option>
            <option value="confirmed_planet">Confirmed Planet</option>
            <option value="candidate">Candidate</option>
            <option value="likely_false_positive">Likely False Positive</option>
            <option value="rocky_candidate">Rocky Candidate</option>
            <option value="super_earth_or_mini_neptune">Super-Earth / Mini-Neptune</option>
            <option value="hot_jupiter_candidate">Hot Jupiter Candidate</option>
            <option value="habitable_zone_candidate">Habitable Zone Candidate</option>
            <option value="anomalous_signal">Anomalous Signal</option>
            <option value="no_result">No Result / Invalid Data</option>
          </select>
        </div>

        <div class="form-actions">
          <button id="btnApplyFilters" type="submit" class="btn btn-primary">Apply</button>
          <button id="btnClearFilters" type="button" class="btn btn-ghost">Clear</button>
        </div>
      </form>
    </section>

    <!-- Results table -->
    <section class="card section">
      <header class="section-header">
        <h2>Objects</h2>
        <p class="section-subtitle">Sorted by object_id. Columns shown are a compact subset for quick inspection.</p>
      </header>

      <div class="table-wrap" style="overflow:auto;">
        <table id="resultsTable" class="table" aria-describedby="resultsSummary">
          <thead>
            <tr>
              <th>Object ID</th>
              <th>Category</th>
              <th>Score</th>
              <th>Flags</th>
              <th>Period (days)</th>
              <th>Radius (R⊕)</th>
              <th>Teq (K)</th>
              <th>Insol (F/F⊕)</th>
            </tr>
          </thead>
          <tbody>
            <!-- Filled dynamically -->
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="site-footer" role="contentinfo">
    <div class="container footer-grid">
      <div>
        <strong>ExoHunter</strong><br />
        <small>© 2025. Anomaly-first exoplanet analytics.</small>
      </div>
      <div class="footer-links">
        <a href="https://exoplanetarchive.ipac.caltech.edu/" target="_blank" rel="noopener">NASA Exoplanet Archive</a>
        <a href="https://www.nasa.gov/" target="_blank" rel="noopener">NASA</a>
      </div>
    </div>
  </footer>

  <script src="/static/js/app.js" defer></script>

  <script>
  (function () {
    "use strict";
    const qs = (s, el=document) => el.querySelector(s);
    const resultsStatus = qs("#resultsStatus");
    const resultsSummary = qs("#resultsSummary");
    const resultsTableBody = qs("#resultsTable tbody");
    const linkDownloadCSV = qs("#linkDownloadCSV");
    const linkDownloadJSON = qs("#linkDownloadJSON");
    const filterForm = qs("#filterForm");
    const searchId = qs("#searchId");
    const categorySelect = qs("#categorySelect");
    const btnClearFilters = qs("#btnClearFilters");
    const btnRefresh = qs("#btnRefreshResults");

    let dataset = [];
    let loading = false;

    function setStatus(msg, type="info"){
      resultsStatus.className = `status status--${type}`;
      resultsStatus.textContent = msg;
    }
    function clearTable(){ while (resultsTableBody.firstChild) resultsTableBody.removeChild(resultsTableBody.firstChild); }
    function safeNumber(v){
      if (v==null || v==="") return "—";
      const n=Number(v);
      if(!Number.isFinite(n)) return String(v);
      if(Math.abs(n)>=100) return n.toFixed(0);
      if(Math.abs(n)>=10) return n.toFixed(1);
      return n.toFixed(2);
    }
    function addRow(r){
      const tr=document.createElement("tr");
      [r.object_id??"—", r.category??"—", (r.score??"")===""?"—":Number(r.score).toFixed(2),
       Array.isArray(r.flags)?r.flags.join("; "):(r.flags??"—"),
       safeNumber(r.koi_period), safeNumber(r.koi_prad), safeNumber(r.koi_teq), safeNumber(r.koi_insol)
      ].forEach(val=>{ const td=document.createElement("td"); td.textContent=val; tr.appendChild(td); });
      resultsTableBody.appendChild(tr);
    }
    function applyFilters(){
      const idQuery=(searchId.value||"").trim().toLowerCase();
      const cat=(categorySelect.value||"").trim();
      let rows=dataset.slice();
      if(idQuery) rows=rows.filter(r=>String(r.object_id||"").toLowerCase().includes(idQuery));
      if(cat) rows=rows.filter(r=>String(r.category||"")===cat);
      return rows;
    }
    function render(ts){
      const filtered=applyFilters();
      clearTable(); filtered.forEach(addRow);
      const summary={ rows_total: dataset.length, rows_shown: filtered.length };
      if (ts) summary.timestamp = ts;
      resultsSummary.textContent = JSON.stringify(summary, null, 2);
    }
    function setDownloadsEnabled(enabled){
      const state = enabled ? null : "true";
      if (enabled) {
        linkDownloadCSV?.setAttribute("href","/api/result/download/csv");
        linkDownloadJSON?.setAttribute("href","/api/result/download/json");
      } else {
        linkDownloadCSV?.setAttribute("href","#");
        linkDownloadJSON?.setAttribute("href","#");
      }
      // accesibilidad
      if (state) {
        linkDownloadCSV?.setAttribute("aria-disabled", state);
        linkDownloadJSON?.setAttribute("aria-disabled", state);
      } else {
        linkDownloadCSV?.removeAttribute("aria-disabled");
        linkDownloadJSON?.removeAttribute("aria-disabled");
      }
    }

    async function refresh(){
      if (loading) return;
      loading = true;
      btnRefresh?.setAttribute("disabled","true");
      btnRefresh?.setAttribute("aria-busy","true");
      setStatus("Fetching latest results…","info");
      try{
        const resp = await fetch("/api/result/latest");
        // Intenta extraer mensaje de error si no es OK
        if(!resp.ok){
          let errMsg = `HTTP ${resp.status}`;
          try {
            const errData = await resp.json();
            if (errData && errData.error) errMsg = errData.error;
          } catch(_) {}
          throw new Error(errMsg);
        }

        const data = await resp.json();
        const rows = Array.isArray(data.rows) ? data.rows.map(r=>{
          const c={...r};
          if (typeof c.flags==="string") c.flags=c.flags.split(";").filter(Boolean);
          return c;
        }) : [];

        dataset = rows;

        setDownloadsEnabled(rows.length > 0);
        setStatus("Results loaded.","success");
        render(data.timestamp);
      }catch(err){
        console.error(err);
        setDownloadsEnabled(false);
        // Muestra el mensaje real del backend si está disponible
        setStatus(`Error loading results: ${err && err.message ? err.message : "unknown error"}`,"error");
        // Limpia la tabla/resumen
        dataset = [];
        render();
      }finally{
        loading = false;
        btnRefresh?.removeAttribute("disabled");
        btnRefresh?.removeAttribute("aria-busy");
      }
    }

    filterForm.addEventListener("submit",(e)=>{ e.preventDefault(); render(); });
    btnClearFilters?.addEventListener("click",()=>{ filterForm.reset(); render(); });
    btnRefresh?.addEventListener("click",()=>{ refresh(); });

    // Primera carga
    refresh();
  })();
  </script>
</body>
</html>
